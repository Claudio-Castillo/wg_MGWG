library(FLa4a)
setwd('../')
idxs <- readFLIndices('survey.dat')
idxs <- window(idxs, end=2016)
stk <- readFLStock('index.low', no.discards = TRUE)
stk <- window(stk, end=2016)
setwd('a4asca')
fit <- sca(stk, idxs)
res <- residuals(fit, stk, idxs)
plot(res)
fit
fmod <- ~te(age, year, k = c(5, 27), bs = "tp") + s(age, k = 3)
fit <- sca(stk, idxs, fmodel=fmod)
res <- residuals(fit, stk, idxs)
plot(res)
fmod <- ~te(age, year, k = c(5, 27), bs = "tp")# + s(age, k = 3)
fit <- sca(stk, idxs, fmodel=fmod)
res <- residuals(fit, stk, idxs)
plot(res)
plot(stk+fit)
fit <- sca(stk, idxs, fmodel=fmod, srmodel=~s(year, k=20)
res <- residuals(fit, stk, idxs)
plot(res)
fmod <- ~te(age, year, k = c(5, 27), bs = "tp")# + s(age, k = 3)
fit <- sca(stk, idxs, fmodel=fmod, srmodel=~s(year, k=20)
res <- residuals(fit, stk, idxs)
plot(res)
fmod <- ~te(age, year, k = c(5, 27), bs = "tp") # + s(age, k = 3)
fit <- sca(stk, idxs, fmodel=fmod, srmodel=~s(year, k=20))
res <- residuals(fit, stk, idxs)
plot(res)
plot(stk+fit)
fmod <- ~te(age, year, k = c(5, 20), bs = "tp") # + s(age, k = 3)
fit <- sca(stk, idxs, fmodel=fmod, srmodel=~s(year, k=20))
res <- residuals(fit, stk, idxs)
plot(res)
plot(stk+fit)
fmod <- ~te(age, year, k = c(5, 20), bs = "tp") # + s(age, k = 3)
fit <- sca(stk, idxs, fmodel=fmod, srmodel=~s(year, k=10))
res <- residuals(fit, stk, idxs)
plot(res)
plot(stk+fit)
index(idxs[[]])
index(idxs[[1]])
index(idxs[[2]])
fit <- sca(window(stk, start=1983), idxs)#, fmodel=fmod, srmodel=~s(year, k=10))
res <- residuals(fit, stk, idxs)
plot(res)
stk <- window(stk, end=2016, start=1983)
fit <- sca(stk, idxs)#, fmodel=fmod, srmodel=~s(year, k=10))
res <- residuals(fit, stk, idxs)
plot(res)
plot(stk+fit)
plot(stk, fit)
plot(fit, stk)
plot(fit, idxs[[1]])
plot(fit, idxs)
plot(fit, idxs[1])
plot(fit, idxs[2])
plot(stk+simulate(fit, 250))
library(ggplotFL)
plot(stk+simulate(fit, 250))
plot(stk+simulate(fit, 250), probs=c(0.1,0.3,0.5,0.7,0.9))
plot(stk+simulate(fit, 250), probs=c(0.05,0.25,0.5,0.75,0.95))
SCAMCMC()
fitmc <- sca(stk, idxs, fit='mcmc', mcmc=SCAMCMC())
fitmc <- sca(stk, idxs, fit='MCMC', mcmc=SCAMCMC())
plot(stk+fitmc)
plot(stk+fit)
plot(stk+fitmc)
plot(stk+simulate(fit, 250))
x11()
plot(stk+fitmc)
fitmc <- sca(stk, idxs, fit='MCMC', mcmc=SCAMCMC(mcprobe=0.1))
plot(stk+fitmc)
fitmc <- sca(stk, idxs, fit='MCMC', mcmc=SCAMCMC(mcprobe=0.05))
plot(stk+fitmc)
fitmc <- sca(stk, idxs, fit='MCMC', mcmc=SCAMCMC(mcprobe=0.4))
plot(stk+fitmc)
plot(stk+fitmc, probs=c(0.025,0.33,0.5,0.66,0.975))
plot(stk+fitmc, probs=c(0.02,0.33,0.5,0.66,0.98))
fit
fitsep <- sca(stk, idxs, fmod=~s(age, k=5) + s(year, k=17))
ressep <- residuals(fitsep, stk, idxs)
plot(ressep)
plot(fitsep, stk)
plot(fitsep, idxs[1])
plot(fitsep, idxs[2])
plot(stk+simulate(fitsep, 250))
fitsepmc <- sca(stk, idxs, fit='MCMC', mcmc=SCAMCMC())
plot(setk+fitsepmc)
plot(stk+fitsepmc)
wireframe(data~year+age, data=harvest(fit))
wireframe(data~year+age, data=harvest(fitsep))
q()
source('algorithm.R')
q()
range(idxs[[1]])
range(idxs[[1]])['maxyear']
range(idxs[[1]])['maxyear']-3
i0 <- lapply(idxs, function(x){
myr <- range(x)['maxyear']
index(x)[,ac((myr-yrs):myr)][] <- NA
x
}
)
library(FLa4a)
i0 <- lapply(idxs, function(x){
myr <- range(x)['maxyear']
index(x)[,ac((myr-yrs):myr)][] <- NA
x
}
)
yrs=3
i0 <- lapply(idxs, function(x){
myr <- range(x)['maxyear']
index(x)[,ac((myr-yrs):myr)][] <- NA
x
})
i0[[1]]
index(i0[[1]])
predIdxs <- function(stk, idxs, yrs=3, ...){
i0 <- lapply(idxs, function(x){
myr <- range(x)['maxyear']
index(x)[,ac((myr-yrs+1):myr)][] <- NA
x
})
args <- list(...)
args$stock <- stk
args$indices <- i0
fit <- do.call("sca", args)
fit
}
fit0 <- predIdxs(stk, idxs)
fit0
fit
index(fit0)
fit0
wireframe(data~year+age, data=harvest(fit))
x11()
wireframe(data~year+age, data=harvest(fit0))
wireframe(data~year+age, data=harvest(fit0)[,ac(2010:2016)])
dev.ff()
dev.off()
dev.off()
wireframe(data~year+age, data=harvest(fit0)[,ac(2010:2016)])
x11()
wireframe(data~year+age, data=harvest(fit)[,ac(2010:2016)])
seq_along(idxs)
predIdxs <- function(stk, idxs, yrs=3, ...){
i0 <- lapply(idxs, function(x){
myr <- range(x)['maxyear']
index(x)[,ac((myr-yrs+1):myr)][] <- NA
x
})
args <- list(...)
args$stock <- stk
args$indices <- i0
fit <- do.call("sca", args)
lst0 <- index(fit)
for(i seq_along(idxs)){
lst0[[i]] <- log(index(idxs)[[i]]/index(fit)[[i]])^2
}
mean(unlist(lst0))
}
predIdxs <- function(stk, idxs, yrs=3, ...){
i0 <- lapply(idxs, function(x){
myr <- range(x)['maxyear']
index(x)[,ac((myr-yrs+1):myr)][] <- NA
x
})
args <- list(...)
args$stock <- stk
args$indices <- i0
fit <- do.call("sca", args)
lst0 <- index(fit)
for(i in seq_along(idxs)){
lst0[[i]] <- log(index(idxs)[[i]]/index(fit)[[i]])^2
}
mean(unlist(lst0))
}
predIdxs(stk, idxs)
predIdxs <- function(stk, idxs, yrs=3, ...){
i0 <- lapply(idxs, function(x){
myr <- range(x)['maxyear']
index(x)[,ac((myr-yrs+1):myr)][] <- NA
x
})
args <- list(...)
args$stock <- stk
args$indices <- i0
fit <- do.call("sca", args)
lst0 <- index(fit)
for(i in seq_along(idxs)){
lst0[[i]] <- log(index(idxs[[i]])/index(fit)[[i]])^2
}
mean(unlist(lst0))
}
predIdxs(stk, idxs)
ra
FLa4a:::ra
retroFuck <- function(stk, idxs, retro=5, ...){
args <- list(...)
lst0 <- split(1:retro, 1:retro)
lst0 <- lapply(lst0, function(x){
yr <- range(stk)["maxyear"] - x
args$stock <- window(stk, end=yr)
args$indices <- window(idx, end=yr)
fit <- do.call("sca", args)
stk + fit
})
}
retroFuck(stk, idxs)
retroFuck <- function(stk, idxs, retro=5, ...){
args <- list(...)
lst0 <- split(1:retro, 1:retro)
lst0 <- lapply(lst0, function(x){
yr <- range(stk)["maxyear"] - x
args$stock <- window(stk, end=yr)
args$indices <- window(idxs, end=yr)
fit <- do.call("sca", args)
stk + fit
})
}
retroFuck(stk, idxs)
debug(retroFuck)
retroFuck(stk, idxs)
lst0
retroFuck <- function(stk, idxs, retro=5, ...){
args <- list(...)
lst0 <- split(0:retro, 0:retro)
lst0 <- lapply(lst0, function(x){
yr <- range(stk)["maxyear"] - x
args$stock <- window(stk, end=yr)
args$indices <- window(idxs, end=yr)
fit <- do.call("sca", args)
stk + fit
})
}
retroFuck <- function(stk, idxs, retro=5, ...){
args <- list(...)
lst0 <- split(0:retro, 0:retro)
lst0 <- lapply(lst0, function(x){browser()
yr <- range(stk)["maxyear"] - x
args$stock <- window(stk, end=yr)
args$indices <- window(idxs, end=yr)
fit <- do.call("sca", args)
stk + fit
})
}
retroFuck(stk, idxs)
n
x
yr
sca(args$stock, args$indices
)
Q
retroFuck <- function(stk, idxs, retro=5, ...){
args <- list(...)
lst0 <- split(0:retro, 0:retro)
lst0 <- lapply(lst0, function(x){
yr <- range(stk)["maxyear"] - x
args$stock <- window(stk, end=yr)
args$indices <- window(idxs, end=yr)
fit <- do.call("sca", args)
args$stock + fit
})
}
retroFuck(stk, idxs)
retroFuck <- function(stk, idxs, retro=5, ...){
args <- list(...)
lst0 <- split(0:retro, 0:retro)
lst0 <- lapply(lst0, function(x){
yr <- range(stk)["maxyear"] - x
args$stock <- window(stk, end=yr)
args$indices <- window(idxs, end=yr)
fit <- do.call("sca", args)
args$stock + fit
})
lst0
}
retroFuck(stk, idxs)->stk.retro
plot(stk.retro)
plot(FLStocks(stk.retro))
retroFuck <- function(stk, idxs, retro=5, ...){
args <- list(...)
lst0 <- split(0:retro, 0:retro)
lst0 <- lapply(lst0, function(x){
yr <- range(stk)["maxyear"] - x
args$stock <- window(stk, end=yr)
args$indices <- window(idxs, end=yr)
fit <- do.call("sca", args)
args$stock + fit
})
FLStocks(lst0)
}
mohn <- function (stks, qoi=c('fbar','ssb','rec'), ...){
lst0 <- list()
length(lst0) <- length(stks)
for(i in seq_along(lst0)){
lst0 <- lapply(stks, i)
browser()
}
}
mohn(stk.retro)
mohn <- function (stks, qoi=c('fbar','ssb','rec'), ...){
lst0 <- list()
length(lst0) <- length(stks)
for(i in seq_along(lst0)){
browser()
lst0 <- lapply(stks, i)
}
}
mohn(stk.retro)
ls()
i
Q
mohn <- function (stks, qoi=c('fbar','ssb','rec'), ...){
lst0 <- list()
length(lst0) <- length(stks)
for(i in seq_along(qoi)){
browser()
lst0 <- lapply(stks, i)
}
}
mohn(stk.retro)
i
Q
mohn <- function (stks, qoi=c('fbar','ssb','rec'), ...){
lst0 <- list()
length(lst0) <- length(stks)
for(i in qoi){
browser()
lst0 <- lapply(stks, i)
}
}
mohn(stk.retro)
i
lst0 <- lapply(stks, i)
lst0
c(lst0)
unlist(lst0)
unlist(lst0)-unlist(lst0[[1]])
data.frame(r=unlist(lst0[-1]),o=unlist(lst0[[1]]))
unlist(lst0[-1])
data.frame(r=unlist(lst0[-1]),o=unlist(lst0[[1]]))
unlist(lst0[[1]])
c(lst0[[1]])
data.frame(r=unlist(lst0[-1]),o=c(lst0[[1]]))
data.frame(o = c(lst0[[1]]), r = unlist(lst0[-1]))
unlist(lst0[-1])/c(lst0[[1]])
unlist(lst0[-1])/c(lst0[[1]])-1
(unlist(lst0[-1])/c(lst0[[1]])-1)
sum(unlist(lst0[-1])/c(lst0[[1]])-1
)
vector()
vector(mode='numeric')
vector(mode='numeric', len=3)
?vector
v0 <- vector(mode='numeric', len=3)
v0
names(v0) <- qoi
v0
Q
mohn <- function (stks, qoi=c('fbar','ssb','rec'), ...){
v0 <- vector(mode='numeric', len=3)
names(v0) <- qoi
for(i in qoi){
lst0 <- lapply(stks, i)
v0[i] <- sum(unlist(lst0[-1])/c(lst0[[1]])-1)
}
}
mohn(stk.retro)
mohn <- function (stks, qoi=c('fbar','ssb','rec'), ...){
v0 <- vector(mode='numeric', len=3)
names(v0) <- qoi
for(i in qoi){
lst0 <- lapply(stks, i)
v0[i] <- sum(unlist(lst0[-1])/c(lst0[[1]])-1)
}
v0
}
mohn <- function (stks, qoi=c('fbar','ssb','rec'), ...){
v0 <- vector(mode='numeric', len=length(qoi))
names(v0) <- qoi
for(i in qoi){
lst0 <- lapply(stks, i)
v0[i] <- sum(unlist(lst0[-1])/c(lst0[[1]])-1)
}
v0
}
mohn(stk.retro)
retro
retro <- function(stk, idxs, retro=5, ...){
args <- list(...)
lst0 <- split(0:retro, 0:retro)
lst0 <- lapply(lst0, function(x){
yr <- range(stk)["maxyear"] - x
args$stock <- window(stk, end=yr)
args$indices <- window(idxs, end=yr)
fit <- do.call("sca", args)
args$stock + fit
})
FLStocks(lst0)
}
fit <- sca(stk, idxs)
stk.retro <- retro(stk, idxs, retro=7)
fit.rm <- mohn(stk.retro)
fit.pi <- predIdxs(stk, idxs)
fit.rm
fit.pi
plot(stk.retro)
fitsep <- sca(stk, idxs, fmod=~s(age, k=5) + s(year, k=17))
fmod <- ~s(age, k=5) + s(year, k=17)
fitsep <- sca(stk, idxs, fmodel=fmod)
stk.retro <- retro(stk, idxs, retro=7, fmodel=fmod)
fit.rm <- mohn(stk.retro)
plot(stk.retro)
fit.rm
fit <- sca(stk, idxs)
stk.retro <- retro(stk, idxs, retro=7)
fit.rm <- mohn(stk.retro)
fit.pi <- predIdxs(stk, idxs)
fmod <- ~s(age, k=5) + s(year, k=17)
fitsep <- sca(stk, idxs, fmodel=fmod)
stksep.retro <- retro(stk, idxs, retro=7, fmodel=fmod)
fitsep.rm <- mohn(stksep.retro)
fitsep.pi <- predIdxs(stksep, idxs)
predIdxs
fitsep.pi <- predIdxs(stk, idxs, fmodel=fmod)
fitsep.pi
fit.pi
q()
